{{ $featured_image := .Params.featured_image }}
{{ $gallery := .Params.gallery }}
{{ $imagePath := "" }}

{{ if $featured_image }}
    {{ $imagePath = printf "%s" $featured_image }}
{{ end }}

<div class="project-card">
    <a href="{{ .Permalink }}" class="project-card-link">
        {{ if or $imagePath $gallery }}
            <div class="project-image-container">
                {{ if $gallery }}
                    <div class="project-carousel">
                        <div class="carousel-images">
                            {{ if $imagePath }}
                                <img src="{{ $imagePath | relURL }}" alt="{{ .Title }} preview" class="carousel-image active">
                            {{ end }}
                            {{ range $gallery }}
                                <img src="{{ . | relURL }}" alt="{{ $.Title }}" class="carousel-image">
                            {{ end }}
                        </div>
                        <button class="carousel-prev" aria-label="Previous image">‹</button>
                        <button class="carousel-next" aria-label="Next image">›</button>
                        <div class="carousel-dots"></div>
                    </div>
                {{ else if $imagePath }}
                    <div class="project-image">
                        <img src="{{ $imagePath | relURL }}" alt="{{ .Title }} preview">
                    </div>
                {{ end }}
            </div>
        {{ else }}
            <div class="project-image project-no-image">
                <span>{{ substr .Title 0 1 }}</span>
            </div>
        {{ end }}
        <div class="project-content">
            <h4>{{ .Title }}</h4>
            {{/* Use a short summary for cards: prefer `card_summary`, then `summary`, then truncated .Summary */}}
            {{/* Prefer explicit card_summary, then description, then summary; collapse whitespace/newlines */}}
            {{ if .Params.card_summary }}
                {{ $card := .Params.card_summary | replaceRE "\\s+" " " | plainify | strings.TrimSpace }}
                <p>{{ $card }}</p>
            {{ else if .Params.description }}
                {{ $desc := .Params.description | replaceRE "\\s+" " " | plainify | strings.TrimSpace }}
                <p>{{ $desc }}</p>
            {{ else if .Params.summary }}
                {{ $sum := .Params.summary | replaceRE "\\s+" " " | plainify | strings.TrimSpace }}
                <p>{{ $sum }}</p>
            {{ else }}
                <p>{{ .Summary | plainify | replaceRE "\\s+" " " | truncate 140 }}</p>
            {{ end }}
            <div class="project-tags">
                {{/* Use Scratch to avoid emitting duplicate tags */}}
                {{ $.Scratch.Set "seenTags" "" }}

                {{/* Render front-matter tags but skip the generic 'Game Engine' tag */}}
                {{ if .Params.tags }}
                    {{ range .Params.tags }}
                        {{ $t := . }}
                        {{ if ne $t "Game Engine" }}
                            {{ $seen := $.Scratch.Get "seenTags" }}
                            {{ if not (in $seen $t) }}
                                <span class="tag">{{ $t }}</span>
                                {{ $.Scratch.Set "seenTags" (print $seen "|" $t) }}
                            {{ end }}
                        {{ end }}
                    {{ end }}
                {{ end }}

                {{/* Show engine as a tag (if present) */}}
                {{ if .Params.engine }}
                    {{ $et := .Params.engine }}
                    {{ $seen := $.Scratch.Get "seenTags" }}
                    {{ if not (in $seen $et) }}
                        <span class="tag">{{ $et }}</span>
                        {{ $.Scratch.Set "seenTags" (print $seen "|" $et) }}
                    {{ end }}
                {{ end }}

                {{/* Show status as a tag; append ' Release' if not already present */}}
                {{ if .Params.status }}
                    {{ $status := .Params.status }}
                    {{ $lower := lower $status }}
                    {{ if not (in $lower "release") }}
                        {{ $status = printf "%s Release" $status }}
                    {{ end }}
                    {{ $seen := $.Scratch.Get "seenTags" }}
                    {{ if not (in $seen $status) }}
                        <span class="tag">{{ $status }}</span>
                        {{ $.Scratch.Set "seenTags" (print $seen "|" $status) }}
                    {{ end }}
                {{ end }}
            </div>
        </div>
    </a>
</div>
